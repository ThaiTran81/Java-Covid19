USE QLC19
  GO

DROP PROC AddNewAccount
go
CREATE PROCEDURE AddNewAccount (@ID VARCHAR(15), @PASSWORD VARCHAR(50), @ROLE INT, @FULLNAME NVARCHAR(100)=NULL,
  @PHONENUMBER VARCHAR(20)=NULL, @DOB DATE=NULL, @GENDER NVARCHAR(5)=NULL, @PROVINE NVARCHAR(50)=NULL, 
  @DISTRICT NVARCHAR(50)=NULL, @VILLAGE NVARCHAR(50)=NULL, @ID_QUARATINE INT=NULL, @RELATED VARCHAR(15)=NULL )
AS 
BEGIN
      DECLARE @ID_BANK INT;
      SET @ID_BANK = NULL;
      IF @ROLE = 2 BEGIN 
        INSERT INTO PAYMENT(BALANCE) VALUES (20000000);
        Set @ID_BANK = (SELECT SCOPE_IDENTITY());
      END
     INSERT INTO PROFILE(ID, FULLNAME, PHONENUMBER, DOB, GENDER, PROVINE, DISTRICT, VILLAGE, ID_QUARATINE, ID_BANK)
     VALUES(@ID, @FULLNAME,@PHONENUMBER,@DOB, @GENDER ,@PROVINE,@DISTRICT,@VILLAGE,@ID_QUARATINE, @ID_BANK)

     INSERT INTO ACCOUNT(USERNAME, PASSWORD, TYPE)
     VALUES(@ID, @PASSWORD,@ROLE)
     
     IF @RELATED!=NULL BEGIN  
     	INSERT INTO RELATE (USERNAME1, USERNAME2, DATE)
      VALUES (@RELATED,  @ID, GETDATE());
     END
     
END;

GO


DROP TRIGGER trigger_sub_consumption
CREATE TRIGGER trigger_sub_consumption
ON CONSUME
FOR DELETE
AS
BEGIN
	UPDATE n
  SET n.CONSUMPTION=n.CONSUMPTION-de.QUANTITY
  FROM NECESSITIES n JOIN DELETED de ON n.ID_NECESSITIES = de.ID_NECESSITIES
END

--tự động thêm giá vào chi tiết hoá đơn
DROP TRIGGER trigger_add_price
CREATE TRIGGER trigger_add_price
ON CONSUME
FOR INSERT
AS
BEGIN

  UPDATE n
  SET CONSUMPTION = n.CONSUMPTION + (i.QUANTITY)
  FROM NECESSITIES n
  JOIN INSERTED i
    ON n.ID_NECESSITIES = i.ID_NECESSITIES

  UPDATE c
  SET c.PRICE = n.PRICE
  FROM CONSUME c
  JOIN INSERTED i
    ON c.ID_BILL = i.ID_BILL
    AND c.ID_NECESSITIES = i.ID_NECESSITIES
  JOIN NECESSITIES n
    ON c.ID_NECESSITIES = n.ID_NECESSITIES
END

INSERT INTO NECESSITIES (NAME, LIMIT, PRICE, TIME_LIMIT,consumption)
  VALUES ('', 0, DEFAULT, 0, DEFAULT);